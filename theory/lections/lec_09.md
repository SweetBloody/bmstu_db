# Базы данных. Лекция 9

### Журнализация

Базы даннных SQL Server содержит файлы трех типов: 
* первичные файлы данных 
* вторичные файлы данных 
* файлы журналов 

#### Операции журнала транзакций 
Журнал транзакций поддерживает следующие операции:
* Восстановление отдельных транзакций 
* Восстановление всех незавершенных транзакций при запуске SQL Server 
* Накат восстановленной базы данных, файла, файловой группы или страницы до момента сбоя 
* Поддержка репликации транзакций 
* Поддержка решений с резервными серверами

#### Модель восстановления 

> Модель восстановления - это свойство базы данных, которое управляет процессом регистрации транзакции, определяет, требуется ли для журнала транзакций резервное копирование, а также определяет, какие типы операций восстановления доступны.

Есть три модели восстановления:
* **Модель полного восстановления** `FULL` - все транзакции записаны полностью (каждая измененная строчка, запись и т.п. это очень большая БД, полная запись всех событий в системе)
  * плюсы: можем восстановить любое состояние системы 
  * минусы: очень много памяти затрачивается (это дорого!)
* **Модель восстановления с неполным протоколированием** `BULK_LOGGED` - можно переключиться в момент выполнения массовых операций для экономии памяти
* **Простая подель восстановления** `SIMPLE` - минимальное хранение операций; требует постоянных дампов

SQL Server поддерживает восстановление данных на следующих уровнях:
* база данных 
* файл данных 
* страница данных 

#### Логическая архитектура журнала транзакций 
На логическом уровне журнал транзакций состоит из последовательных записей. Двумя основными типами записи Log-файла являются:
* код выполненной логической операции 
  * Для наката логической операции выполняется эта операция.
  * Для отката логической операции выполняется логическая операция, обратная зарегистрированной.
* исходный и результирующий образ измененных данных 
  * Для наката операции применяется результирующий образ
  * Для отката операции применяется исходный образ 

TODO (добавить картинку архитектуры журнала)

MinLSN - такая точка, которая гарантирует полное восстановление базы данных.

#### Контрольные точки и активная часть журнала 

Контрольная точка выполняет в базе данных следующее:
* записывает в файл журнала запись, отмечающую начало контрольной точки 
* Сохраняет данные, записанные для контрольной точки в цепи записей журнала контрольной точки 
* Если БД использует простую модель восстановления, помечает для повторного использования пространство ...
* TODO 

#### Активный журнал 
Часть журнала, начинающаяся с номера MinLSN и заканчивающаяся последней записью, называется **активной частью журнала**, или **активным журналом**. Этот раздел журнала необходим для полного восстановления БД.

Чтобы логический журнал не увеличивался до размера физических файлов журнала, следует периодически выполнять его **усечение**. Процесс усечения журнала уменьшает размер файла логического журнала, помечая виртуальные файлы журнала, которые не содержат частей логического журнала, как неактивные.

